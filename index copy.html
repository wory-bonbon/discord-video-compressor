<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Discordç”¨ å‹•ç”»ã‚«ãƒƒãƒˆï¼†åœ§ç¸®ãƒ„ãƒ¼ãƒ«</title>
    <meta name="description" content="Discordç„¡æ–™ãƒ—ãƒ©ãƒ³ã®10MBåˆ¶é™ã«å¯¾å¿œã€‚ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ç”»ã‚’ã‚«ãƒƒãƒˆãƒ»åœ§ç¸®ã—ã¦WebMå½¢å¼ã§å‡ºåŠ›ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸è¦ã€å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã€‚" />
    <meta name="author" content="wory-bonbon" />
    <!-- OGP -->
    <meta property="og:title" content="Discordç”¨ å‹•ç”»ã‚«ãƒƒãƒˆï¼†åœ§ç¸®ãƒ„ãƒ¼ãƒ«" />
    <meta property="og:description" content="10MBåˆ¶é™å¯¾å¿œã€‚ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ç”»ã‚’ã‚«ãƒƒãƒˆãƒ»åœ§ç¸®ã€‚å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã€‚" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://wory-bonbon.github.io/discord-video-compressor/" />
    <meta name="twitter:card" content="summary" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 24px 32px;
        background: #fafafa;
        color: #1f2937;
        min-height: 100vh;
      }

      /* ===== ç”»é¢å…¨ä½“ã§ãƒ‰ãƒ­ãƒƒãƒ—å—ä»˜ ===== */
      body.dragover::after {
        content: 'ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(168, 139, 250, 0.15);
        font-size: 24px;
        font-weight: 600;
        color: #7c3aed;
        pointer-events: none;
        z-index: 1000;
        border: 3px dashed #a78bfa;
      }

      /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
      header {
        margin-bottom: 20px;
      }
      header h1 {
        font-size: 22px;
        font-weight: 700;
        margin: 0 0 8px 0;
        color: #111827;
      }
      header p {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
      }
      header .drop-hint {
        color: #7c3aed;
        font-weight: 500;
      }
      header a {
        color: #7c3aed;
        text-decoration: none;
        font-weight: 500;
      }
      header a:hover {
        text-decoration: underline;
      }

      /* ===== å‹•ç”»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå·¦å³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ ===== */
      .video-container {
        display: flex;
        gap: 20px;
      }
      @media (max-width: 900px) {
        .video-container {
          flex-direction: column;
        }
      }
      .video-panel {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
      }
      .video-panel-label {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 10px;
        padding: 8px 14px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .video-panel.original .video-panel-label,
      .video-panel.preview .video-panel-label {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #4338ca;
      }

      /* ===== ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³èƒŒæ™¯ ===== */
      .video-wrapper {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        
        /* ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ */
        background-color: #ffffff;
        background-image: 
          linear-gradient(45deg, rgba(0,0,0,0.04) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.04) 75%),
          linear-gradient(45deg, rgba(0,0,0,0.04) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.04) 75%);
        background-size: 16px 16px;
        background-position: 0 0, 8px 8px;
        
        /* å¢ƒç•Œç·š */
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      }
      .video-wrapper video {
        width: 100%;
        height: 100%;
        min-height: 300px;
        max-height: 58vh;
        object-fit: contain;
        display: block;
      }

      /* ===== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ã‚«ãƒ¼ ===== */
      .timeline-section {
        margin-top: 12px;
      }
      .timeline-container {
        position: relative;
        height: 32px;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid rgba(0,0,0,0.06);
      }
      .timeline-progress {
        height: 100%;
        background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%);
        border-radius: 8px;
        width: 0%;
        opacity: 0.5;
      }
      .timeline-marker {
        position: absolute;
        top: -2px;
        transform: translateX(-50%);
        font-size: 18px;
        line-height: 1;
        cursor: ew-resize;
        user-select: none;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
      }
      .timeline-marker.start {
        color: #7c3aed;
      }
      .timeline-marker.end {
        color: #ec4899;
      }
      .timeline-marker-label {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        font-weight: 600;
        white-space: nowrap;
        margin-top: 4px;
        background: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        color: #6b7280;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .timeline-time {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #9ca3af;
        margin-top: 6px;
        font-weight: 500;
      }

      /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== */
      .controls {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-start;
        padding: 16px 20px;
        background: #fff;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,0.06);
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      }
      .control-item {
        display: flex;
        flex-direction: column;
      }
      .control-item label {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .control-item input[type="text"],
      .control-item select {
        padding: 10px 12px;
        background: #f9fafb;
        color: #1f2937;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        min-width: 100px;
        height: 42px;
        font-size: 14px;
        font-weight: 500;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      .control-item input[type="text"]:focus,
      .control-item select:focus {
        outline: none;
        border-color: #a78bfa;
        box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.15);
      }
      .control-hint {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 4px;
        min-height: 14px;
      }
      .control-item button {
        height: 42px;
        padding: 0 24px;
        background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
        border: none;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: transform 0.1s, box-shadow 0.15s;
        box-shadow: 0 2px 8px rgba(124, 58, 237, 0.25);
      }
      .control-item button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
      }
      .control-item button:active {
        transform: translateY(0);
      }
      .control-item button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* ===== ç›®å®‰è¡¨ç¤º ===== */
      .info-cards {
        margin-top: 16px;
        display: flex;
        gap: 16px;
      }
      @media (max-width: 900px) {
        .info-cards {
          flex-direction: column;
        }
      }
      .info-card {
        flex: 1;
        font-size: 12px;
        color: #6b7280;
        background: #fff;
        padding: 14px 18px;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,0.06);
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      }
      .info-card-title {
        color: #374151;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 13px;
      }
      .info-card ul {
        margin: 8px 0 0 0;
        padding-left: 18px;
      }
      .info-card li {
        margin-bottom: 4px;
        color: #6b7280;
      }
      .info-card .note {
        color: #9ca3af;
        font-size: 11px;
        margin-top: 8px;
      }

      /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰å†… */
      .status-content {
        min-height: 60px;
      }
      #status {
        font-size: 13px;
        font-weight: 500;
        white-space: pre-line;
        color: #374151;
        margin-bottom: 8px;
      }
      #sizeInfo {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 12px;
      }
      #downloadLink {
        display: none;
        padding: 12px 24px;
        border-radius: 8px;
        background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
        color: #fff;
        text-decoration: none;
        font-size: 14px;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(124, 58, 237, 0.25);
        transition: transform 0.1s, box-shadow 0.15s;
      }
      #downloadLink:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
      }

      /* hiddenç”¨ */
      input[type="file"] {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
    <header>
      <h1>Discordç”¨ å‹•ç”»ã‚«ãƒƒãƒˆï¼†åœ§ç¸®ãƒ„ãƒ¼ãƒ«</h1>
      <p>
        <span class="drop-hint">ç”»é¢ã«å‹•ç”»ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</span>ã€ã¾ãŸã¯
        <a href="#" id="fileSelectLink">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</a>ã€‚
        åˆ‡ã‚Šå‡ºã—ç¯„å›²ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¦éŒ²ç”»ãƒ»åœ§ç¸®ã—ã¾ã™ï¼ˆå‡ºåŠ›: WebMï¼‰
      </p>
    </header>
    <input type="file" id="fileInput" accept="video/*" />

    <!-- ===== å‹•ç”»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== -->
    <div id="videoContainer" class="video-container" hidden>
      <!-- ã‚ªãƒªã‚¸ãƒŠãƒ«å´ -->
      <div class="video-panel original">
        <div class="video-panel-label">ğŸ“¹ ã‚ªãƒªã‚¸ãƒŠãƒ«</div>
        <div class="video-wrapper">
          <video id="video" controls></video>
        </div>
        <div class="timeline-section">
          <div id="timeline" class="timeline-container">
            <div id="timelineProgress" class="timeline-progress"></div>
            <div id="startMarker" class="timeline-marker start" title="ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®">
              â–¼
              <span class="timeline-marker-label">0s</span>
            </div>
            <div id="endMarker" class="timeline-marker end" title="ã‚¨ãƒ³ãƒ‰ä½ç½®">
              â–¼
              <span class="timeline-marker-label">0s</span>
            </div>
          </div>
          <div class="timeline-time">
            <span>0:00</span>
            <span id="durationDisplay">0:00</span>
          </div>
        </div>
      </div>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´ -->
      <div class="video-panel preview">
        <div class="video-panel-label">â–¶ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡ºåŠ›</div>
        <div id="previewWrapper" class="video-wrapper">
          <video id="previewVideo" controls></video>
        </div>
      </div>
    </div>

    <!-- ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== -->
    <div id="controls" class="controls" hidden>
      <div class="control-item">
        <label>ã‚¹ã‚¿ãƒ¼ãƒˆ (ç§’)</label>
        <input type="text" id="startTime" value="0" inputmode="decimal" />
        <span class="control-hint">ãƒ›ã‚¤ãƒ¼ãƒ«ã§Â±1ç§’</span>
      </div>
      <div class="control-item">
        <label>ã‚¨ãƒ³ãƒ‰ (ç§’)</label>
        <input type="text" id="endTime" value="0" inputmode="decimal" />
        <span class="control-hint">ãƒ›ã‚¤ãƒ¼ãƒ«ã§Â±1ç§’</span>
      </div>
      <div class="control-item">
        <label>è§£åƒåº¦ (å¹…)</label>
        <select id="resolution">
          <option value="original">ã‚ªãƒªã‚¸ãƒŠãƒ«</option>
          <option value="1920">1920</option>
          <option value="1280">1280</option>
          <option value="960">960</option>
          <option value="640">640</option>
          <option value="480">480</option>
          <option value="320">320</option>
        </select>
        <span class="control-hint"></span>
      </div>
      <div class="control-item">
        <label>ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ (kbps)</label>
        <select id="bitrate">
          <option value="8000">8000</option>
          <option value="6000">6000</option>
          <option value="5000">5000</option>
          <option value="4000">4000</option>
          <option value="3000">3000</option>
          <option value="2500">2500</option>
          <option value="2000">2000</option>
          <option value="1600">1600</option>
          <option value="1500">1500</option>
          <option value="1200">1200</option>
          <option value="1000">1000</option>
          <option value="800">800</option>
          <option value="600">600</option>
        </select>
        <span class="control-hint"></span>
      </div>
      <div class="control-item">
        <label>å†ç”Ÿé€Ÿåº¦</label>
        <select id="playbackSpeed">
          <option value="0.5">0.5x (ã‚¹ãƒ­ãƒ¼)</option>
          <option value="0.75">0.75x</option>
          <option value="1" selected>1x (é€šå¸¸)</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x (å€é€Ÿ)</option>
        </select>
        <span class="control-hint">â€»éŸ³å£°ãƒ”ãƒƒãƒã‚‚å¤‰åŒ–</span>
      </div>
      <div class="control-item">
        <label>&nbsp;</label>
        <button id="previewBtn" disabled>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        <span class="control-hint"></span>
      </div>
    </div>

    <!-- ===== ä¸‹éƒ¨3ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== -->
    <div id="infoCards" class="info-cards" hidden>
      <!-- ç›®å®‰ã‚«ãƒ¼ãƒ‰ -->
      <div class="info-card">
        <div class="info-card-title">ğŸ“Š Discord ç„¡æ–™ãƒ—ãƒ©ãƒ³ (10MBåˆ¶é™) ã®ç›®å®‰</div>
        <ul>
          <li>8 ç§’: å¹… 1920px / 6,000ï½8,000 kbps</li>
          <li>15 ç§’: å¹… 1280px / 4,000ï½5,000 kbps</li>
          <li>30 ç§’: å¹… 960px / 2,000ï½2,500 kbps</li>
          <li>45 ç§’: å¹… 640px / 1,200ï½1,600 kbps</li>
        </ul>
        <p class="note">â€» éŸ³å£°128ï½160kbpsæƒ³å®š</p>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ -->
      <div class="info-card">
        <div class="info-card-title">âš¡ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="status-content">
          <div id="status">å‹•ç”»ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
          <div id="sizeInfo"></div>
          <a id="downloadLink" download="output.webm">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
        </div>
      </div>

      <!-- ä½¿ã„æ–¹ã‚«ãƒ¼ãƒ‰ -->
      <div class="info-card">
        <div class="info-card-title">ğŸ“– ä½¿ã„æ–¹</div>
        <ol style="margin: 0; padding-left: 18px;">
          <li>å‹•ç”»ã‚’ç”»é¢ã«ãƒ‰ãƒ­ãƒƒãƒ—</li>
          <li>â–¼ãƒãƒ¼ã‚«ãƒ¼ã¾ãŸã¯å…¥åŠ›æ¬„ã§ç¯„å›²æŒ‡å®š</li>
          <li>è§£åƒåº¦ãƒ»ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆãƒ»é€Ÿåº¦ã‚’è¨­å®š</li>
          <li>ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã§éŒ²ç”»é–‹å§‹</li>
          <li>å®Œäº†å¾Œã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€</li>
        </ol>
      </div>
    </div>

    <script>
      // ========== è¦ç´ å–å¾— ==========
      const fileInput = document.getElementById('fileInput');
      const fileSelectLink = document.getElementById('fileSelectLink');
      const videoContainer = document.getElementById('videoContainer');
      const video = document.getElementById('video');
      const controls = document.getElementById('controls');
      const startTimeInput = document.getElementById('startTime');
      const endTimeInput = document.getElementById('endTime');
      const resolutionSelect = document.getElementById('resolution');
      const bitrateSelect = document.getElementById('bitrate');
      const playbackSpeedSelect = document.getElementById('playbackSpeed');
      const previewBtn = document.getElementById('previewBtn');
      const previewVideo = document.getElementById('previewVideo');
      const statusEl = document.getElementById('status');
      const sizeInfoEl = document.getElementById('sizeInfo');
      const downloadLink = document.getElementById('downloadLink');
      const infoCardsEl = document.getElementById('infoCards');

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³é–¢é€£
      const timeline = document.getElementById('timeline');
      const timelineProgress = document.getElementById('timelineProgress');
      const startMarker = document.getElementById('startMarker');
      const endMarker = document.getElementById('endMarker');
      const durationDisplay = document.getElementById('durationDisplay');

      let videoDuration = 0;
      let recording = false;

      // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
      function setStatus(msg, error = false) {
        statusEl.textContent = msg;
        statusEl.style.color = error ? '#dc2626' : '#374151';
      }

      function humanSize(bytes) {
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      }

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s.toString().padStart(2, '0')}`;
      }

      // ========== ãƒãƒ¼ã‚«ãƒ¼ä½ç½®æ›´æ–° ==========
      function updateMarkers() {
        const start = parseFloat(startTimeInput.value) || 0;
        const end = parseFloat(endTimeInput.value) || videoDuration;
        
        if (videoDuration > 0) {
          const startPercent = (start / videoDuration) * 100;
          const endPercent = (end / videoDuration) * 100;
          
          startMarker.style.left = `${Math.min(Math.max(startPercent, 0), 100)}%`;
          endMarker.style.left = `${Math.min(Math.max(endPercent, 0), 100)}%`;
          
          startMarker.querySelector('.timeline-marker-label').textContent = `${start.toFixed(1)}s`;
          endMarker.querySelector('.timeline-marker-label').textContent = `${end.toFixed(1)}s`;
        }
      }

      function updateTimelineProgress() {
        if (videoDuration > 0) {
          const percent = (video.currentTime / videoDuration) * 100;
          timelineProgress.style.width = `${percent}%`;
        }
      }

      // ========== ãƒ›ã‚¤ãƒ¼ãƒ«ã§å€¤å¤‰æ›´ ==========
      function attachWheelToInput(input, min, getMax, step = 1) {
        input.addEventListener('wheel', (e) => {
          e.preventDefault();
          let val = parseFloat(input.value) || 0;
          if (e.deltaY < 0) {
            val = Math.min(val + step, getMax());
          } else {
            val = Math.max(val - step, min);
          }
          input.value = val.toFixed(1);
          validateTimes();
          updateMarkers();
        });
      }

      function attachScrollSelect(select) {
        select.addEventListener('wheel', (e) => {
          e.preventDefault();
          const options = select.options;
          let idx = select.selectedIndex;
          if (e.deltaY > 0) {
            if (idx < options.length - 1) idx++;
          } else {
            if (idx > 0) idx--;
          }
          select.selectedIndex = idx;
        });
      }

      attachWheelToInput(startTimeInput, 0, () => videoDuration, 1);
      attachWheelToInput(endTimeInput, 0, () => videoDuration, 1);
      attachScrollSelect(resolutionSelect);
      attachScrollSelect(bitrateSelect);
      attachScrollSelect(playbackSpeedSelect);

      startTimeInput.addEventListener('focus', () => startTimeInput.select());
      endTimeInput.addEventListener('focus', () => endTimeInput.select());

      // ========== ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ ==========
      async function handleFile(file) {
        if (!file || !file.type.startsWith('video/')) {
          setStatus('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
          return;
        }

        const url = URL.createObjectURL(file);
        video.src = url;
        await video.play().catch(() => {});
        video.pause();
        video.currentTime = 0;
        
        videoDuration = video.duration;
        startTimeInput.value = '0';
        endTimeInput.value = Math.floor(videoDuration).toString();
        
        durationDisplay.textContent = formatTime(videoDuration);
        
        videoContainer.hidden = false;
        controls.hidden = false;
        infoCardsEl.hidden = false;
        previewBtn.disabled = false;
        
        previewVideo.src = '';
        
        updateMarkers();
        setStatus('å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ç¯„å›²ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        sizeInfoEl.textContent = '';
        downloadLink.style.display = 'none';
      }

      // ========== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ==========
      function validateTimes() {
        const startVal = parseFloat(startTimeInput.value);
        const endValRaw = parseFloat(endTimeInput.value);
        
        if (isNaN(startVal) || isNaN(endValRaw)) return;
        
        if (endValRaw > videoDuration) {
          endTimeInput.value = Math.floor(videoDuration).toString();
        }
        
        if (startVal >= endValRaw) {
          setStatus('ã‚¨ãƒ³ãƒ‰æ™‚é–“ã¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚ˆã‚Šå¤§ãã„å€¤ã«ã—ã¦ãã ã•ã„ã€‚', true);
        } else {
          setStatus('');
        }
        
        updateMarkers();
      }

      startTimeInput.addEventListener('change', validateTimes);
      endTimeInput.addEventListener('change', validateTimes);
      startTimeInput.addEventListener('input', updateMarkers);
      endTimeInput.addEventListener('input', updateMarkers);

      video.addEventListener('timeupdate', updateTimelineProgress);

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚·ãƒ¼ã‚¯
      timeline.addEventListener('click', (e) => {
        const rect = timeline.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        video.currentTime = percent * videoDuration;
      });

      // ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°
      let draggingMarker = null;

      function startDrag(marker, inputEl) {
        return (e) => {
          e.stopPropagation();
          draggingMarker = { marker, inputEl };
          document.addEventListener('mousemove', onDrag);
          document.addEventListener('mouseup', stopDrag);
        };
      }

      function onDrag(e) {
        if (!draggingMarker) return;
        const rect = timeline.getBoundingClientRect();
        let percent = (e.clientX - rect.left) / rect.width;
        percent = Math.max(0, Math.min(1, percent));
        const time = percent * videoDuration;
        draggingMarker.inputEl.value = time.toFixed(1);
        validateTimes();
        updateMarkers();
      }

      function stopDrag() {
        draggingMarker = null;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', stopDrag);
      }

      startMarker.addEventListener('mousedown', startDrag(startMarker, startTimeInput));
      endMarker.addEventListener('mousedown', startDrag(endMarker, endTimeInput));

      // ========== éŒ²ç”»å‡¦ç† ==========
      async function recordClip() {
        if (recording) return;
        
        const start = parseFloat(startTimeInput.value) || 0;
        const end = parseFloat(endTimeInput.value) || videoDuration;
        const playbackSpeed = parseFloat(playbackSpeedSelect.value) || 1;
        
        let width;
        if (resolutionSelect.value === 'original') {
          width = video.videoWidth;
        } else {
          width = parseInt(resolutionSelect.value);
        }
        const bitrate = parseInt(bitrateSelect.value) * 1000;
        const height = Math.round(video.videoHeight * width / video.videoWidth);
        
        recording = true;
        previewBtn.disabled = true;
        setStatus('éŒ²ç”»ã‚’é–‹å§‹ã—ã¾ã™â€¦');

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        const canvasStream = canvas.captureStream();
        const audioTracks = video.captureStream().getAudioTracks();
        if (audioTracks.length > 0) {
          canvasStream.addTrack(audioTracks[0]);
        }

        let mimeType = 'video/webm';
        if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')) {
          mimeType = 'video/webm;codecs=vp9,opus';
        } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus')) {
          mimeType = 'video/webm;codecs=vp8,opus';
        }

        const recorder = new MediaRecorder(canvasStream, {
          mimeType: mimeType,
          videoBitsPerSecond: bitrate,
        });
        
        const chunks = [];
        recorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };

        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: recorder.mimeType });
          const sizeMB = blob.size / (1024 * 1024);

          if (blob.size === 0) {
            setStatus('éŒ²ç”»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚', true);
            sizeInfoEl.textContent = 'å‡ºåŠ›ã‚µã‚¤ã‚º: 0.00 MB';
            downloadLink.style.display = 'none';
            recording = false;
            previewBtn.disabled = false;
            return;
          }

          const url = URL.createObjectURL(blob);
          previewVideo.src = url;
          previewVideo.currentTime = 0;
          previewVideo.play().catch(() => {});

          downloadLink.href = url;
          downloadLink.style.display = 'inline-block';
          sizeInfoEl.textContent = 'å‡ºåŠ›ã‚µã‚¤ã‚º: ' + humanSize(blob.size);

          if (sizeMB <= 10) {
            setStatus('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ã€‚Discord ã«ã‚¢ãƒƒãƒ—ã§ãã¾ã™ã€‚');
          } else {
            setStatus('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ã—ã¾ã—ãŸãŒ 10MB ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚', true);
          }

          recording = false;
          previewBtn.disabled = false;
        };

        // ===== ã‚·ãƒ¼ã‚¯å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰éŒ²ç”»é–‹å§‹ =====
        const duration = end - start;
        const expectedTime = duration / playbackSpeed;
        
        video.playbackRate = playbackSpeed;
        video.currentTime = start;
        
        setStatus(`ã‚·ãƒ¼ã‚¯ä¸­â€¦`);
        
        video.onseeked = () => {
          video.onseeked = null;
          
          recorder.start();
          video.play();
          
          setStatus(`éŒ²ç”»ä¸­â€¦ (ç´„${expectedTime.toFixed(1)}ç§’ã‹ã‹ã‚Šã¾ã™)`);
          
          function draw() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            if (video.currentTime >= end || video.currentTime >= video.duration || video.ended) {
              recorder.stop();
              video.pause();
              video.playbackRate = 1;
              return;
            }
            requestAnimationFrame(draw);
          }
          draw();
        };
      }

      previewBtn.addEventListener('click', recordClip);

      // ========== ç”»é¢å…¨ä½“ã§ãƒ‰ãƒ­ãƒƒãƒ— ==========
      document.body.addEventListener('dragenter', (e) => {
        e.preventDefault();
        document.body.classList.add('dragover');
      });

      document.body.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      document.body.addEventListener('dragleave', (e) => {
        if (e.target === document.body || !document.body.contains(e.relatedTarget)) {
          document.body.classList.remove('dragover');
        }
      });

      document.body.addEventListener('drop', (e) => {
        e.preventDefault();
        document.body.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files && files[0]) {
          handleFile(files[0]);
        }
      });

      // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
      fileSelectLink.addEventListener('click', (e) => {
        e.preventDefault();
        fileInput.click();
      });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      });
    </script>
  </body>
</html>
